name: Docker Build & Publish

on:
  push:
    branches: [main]
    paths:
      - "Dockerfile.ros"
      - "Dockerfile.ros_torch"
      - "costnav_isaacsim/isaac_sim_teleop_ros2/**"
      - "costnav_isaacsim/il_evaluation/**"
      - "third_party/visualnav-transformer/**"
      - "docker/**"

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ── ROS2 Teleop image ──────────────────────────────────────────────────
  ros2:
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: false

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.ros
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ros2:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ros2:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── ViNT Evaluation image ──────────────────────────────────────────────
  vint:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          submodules: false

      - name: Init required submodules
        run: |
          git submodule update --init --depth 1 \
            third_party/visualnav-transformer

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.ros_torch
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/vint:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/vint:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
