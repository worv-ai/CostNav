services:
  # Isaac Sim environment
  isaac-sim:
    profiles: [ "isaac-sim" ]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-sim
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaacsim-${ISAAC_SIM_VERSION}:${COSTNAV_VERSION}
    container_name: costnav-isaac-sim
    user: "${ISAAC_UID:-1234}:${ISAAC_GID:-1234}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "${GPU_DEVICE_IDS:-0}" ]
              capabilities: [ gpu ]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - OMNI_KIT_ACCEPT_EULA=YES
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/omniverse_map:/omniverse_map:ro
      - ${HOME}/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ${HOME}/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ${HOME}/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ${HOME}/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ${HOME}/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ${HOME}/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
    network_mode: host
    stdin_open: true
    tty: true

  # Isaac Lab environment
  isaac-lab:
    profiles: [ "isaac-lab" ]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-lab
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaaclab-${ISAAC_SIM_VERSION}-${ISAAC_LAB_VERSION}:${COSTNAV_VERSION}
    container_name: ${CONTAINER_NAME:-costnav-isaac-lab}
    user: "${ISAAC_UID:-1234}:${ISAAC_GID:-1234}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "${GPU_DEVICE_IDS:-0}" ]
              capabilities: [ gpu ]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/omniverse_map:/omniverse_map:ro
      - ${HOME}/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ${HOME}/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ${HOME}/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ${HOME}/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ${HOME}/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ${HOME}/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
    network_mode: host
    stdin_open: true
    tty: true
    # Development environment (minimal dependencies)
  dev:
    profiles: [ "dev" ]
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    image: costnav-dev:${COSTNAV_VERSION}
    container_name: costnav-dev
    env_file:
      - .env
    volumes:
      - .:/workspace
    network_mode: host
    stdin_open: true
    tty: true
    command: sleep infinity
