# Define a reusable block for ROS2 service configuration
# Mounts the pre-built Isaac Sim ROS workspace from the host
# The workspace should be built using: make build-ros-ws
x-ros2-service: &ros2-service
  build:
    context: .
    dockerfile: Dockerfile.ros
  image: costnav-ros2-jazzy:${COSTNAV_VERSION:-0.1.0}
  volumes:
    - ./costnav_isaacsim/nav2_params:/workspace/costnav_isaacsim/nav2_params
    - /tmp/.X11-unix:/tmp/.X11-unix:rw
    - ${XAUTHORITY}:/tmp/.Xauthority:ro
  working_dir: /workspace
  network_mode: host
  ipc: host
  stdin_open: true
  tty: true

services:
  # Isaac Sim environment
  isaac-sim:
    profiles: ["isaac-sim", "nav2", "teleop", "vint"]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-sim
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaacsim-${ISAAC_SIM_VERSION}:${COSTNAV_VERSION}
    container_name: costnav-isaac-sim
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - OMNI_KIT_ACCEPT_EULA=YES
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1}
      - ROBOT_PRIM_PATH=${ROBOT_PRIM_PATH:-}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
      - NUM_PEOPLE=${NUM_PEOPLE:-20}
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1}
      - FOOD=${FOOD:-True}
      - GOAL_IMAGE=${GOAL_IMAGE:-False}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/isaac-sim/cache/kit:/isaac-sim/kit/cache:rw
      - /tmp/isaac-sim/cache/ov:/root/.cache/ov:rw
      - /tmp/isaac-sim/cache/pip:/root/.cache/pip:rw
      - /tmp/isaac-sim/cache/glcache:/root/.cache/nvidia/GLCache:rw
      - /tmp/isaac-sim/cache/computecache:/root/.nv/ComputeCache:rw
      - /tmp/isaac-sim/logs:/root/.nvidia-omniverse/logs:rw
      - /tmp/isaac-sim/data:/root/.local/share/ov/data:rw
      - /tmp/isaac-sim/documents:/root/Documents:rw
      - ./third_party/PeopleAPI/exts:/isaac-sim/extsUser:rw
      - ./third_party/FoodAssets/exts/worvai.assets.food:/isaac-sim/extsUser/worvai.assets.food:rw
    working_dir: /workspace
    command:
      - "-ic"
      - "/workspace/costnav_isaacsim/costnav_isaacsim/launch.py --people $${NUM_PEOPLE:-20} --robot $${SIM_ROBOT:-segway_e1} --food-enabled $${FOOD:-True} --goal-image-enabled $${GOAL_IMAGE:-False}"
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "[ -e /tmp/.isaac_sim_running ] || exit 1 && exit 0",
        ]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 5s
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true

  # Isaac Lab environment
  isaac-lab:
    profiles: ["isaac-lab"]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-lab
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaaclab-${ISAAC_SIM_VERSION}-${ISAAC_LAB_VERSION}:${COSTNAV_VERSION}
    container_name: ${CONTAINER_NAME:-costnav-isaac-lab}
    user: "${ISAAC_UID:-1234}:${ISAAC_GID:-1234}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/isaac-sim/cache/kit:/isaac-sim/kit/cache:rw
      - /tmp/isaac-sim/cache/ov:/root/.cache/ov:rw
      - /tmp/isaac-sim/cache/pip:/root/.cache/pip:rw
      - /tmp/isaac-sim/cache/glcache:/root/.cache/nvidia/GLCache:rw
      - /tmp/isaac-sim/cache/computecache:/root/.nv/ComputeCache:rw
      - /tmp/isaac-sim/logs:/root/.nvidia-omniverse/logs:rw
      - /tmp/isaac-sim/data:/root/.local/share/ov/data:rw
      - /tmp/isaac-sim/documents:/root/Documents:rw
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true
    # Development environment (minimal dependencies)
  dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    image: costnav-dev:${COSTNAV_VERSION}
    container_name: costnav-dev
    env_file:
      - .env
    volumes:
      - .:/workspace
    network_mode: host
    stdin_open: true
    tty: true
    command: sleep infinity

  # ROS2 Jazzy Container for development
  ros2:
    <<: *ros2-service
    profiles: ["ros2"]
    container_name: costnav-ros2
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
    volumes:
      - ./costnav_isaacsim/nav2_params:/workspace/costnav_isaacsim/nav2_params
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY}:/tmp/.Xauthority:ro
      - .:/workspace
    command: sleep infinity

  # ROS2 with Nav2 - waits for Isaac Sim to be healthy before starting
  ros2-nav2:
    <<: *ros2-service
    profiles: ["nav2"]
    container_name: costnav-ros2-nav2
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1}
      - TUNED=${TUNED:-False}
    depends_on:
      isaac-sim:
        condition: service_healthy
    command: >
      bash -c "
        if [ \"$${TUNED}\" = \"True\" ]; then
          PARAMS_FILE=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation_params_tuned_true.yaml
        else
          PARAMS_FILE=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation_params_tuned_false.yaml
        fi &&
        ros2 launch /workspace/costnav_isaacsim/nav2_params/nav2.launch.py params_file:=$${PARAMS_FILE}
      "

  # ROS2 with RViz - standalone visualization service that runs alongside Isaac Sim
  ros2-rviz-nav2:
    <<: *ros2-service
    profiles: ["isaac-sim", "nav2", "vint"]
    container_name: costnav-ros2-rviz-nav2
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1}
      - TUNED=${TUNED:-True}
      - AMCL=${AMCL:-False}
    depends_on:
      isaac-sim:
        condition: service_healthy
    command: >
      bash -c "
        if [ \"$${TUNED}\" = \"True\" ]; then
          PARAMS_FILE=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation_params_tuned_true.yaml
        else
          PARAMS_FILE=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation_params_tuned_false.yaml
        fi &&
        RVIZ_LAUNCH=/workspace/costnav_isaacsim/nav2_params/rviz.launch.py &&
        if [ \"$${AMCL}\" = \"False\" ]; then
          RVIZ_LAUNCH=/workspace/costnav_isaacsim/nav2_params/rviz_no_amcl.launch.py
        fi &&
        ros2 launch $${RVIZ_LAUNCH} rviz_config:=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation.rviz map:=/workspace/costnav_isaacsim/nav2_params/maps/sidewalk.yaml params_file:=$${PARAMS_FILE}
      "

  # ROS2 with RViz (teleop profile) - hides TF/point clouds by default
  ros2-rviz-teleop:
    <<: *ros2-service
    profiles: ["teleop"]
    container_name: costnav-ros2-rviz-teleop
    depends_on:
      isaac-sim:
        condition: service_healthy
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - LIBGL_ALWAYS_SOFTWARE=1
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1}
      - TUNED=${TUNED:-True}
      - AMCL=${AMCL:-False}
    command: >
      bash -c "
        if [ \"$${TUNED}\" = \"True\" ]; then
          PARAMS_FILE=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation_params_tuned_true.yaml
        else
          PARAMS_FILE=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation_params_tuned_false.yaml
        fi &&
        RVIZ_LAUNCH=/workspace/costnav_isaacsim/nav2_params/rviz.launch.py &&
        if [ \"$${AMCL}\" = \"False\" ]; then
          RVIZ_LAUNCH=/workspace/costnav_isaacsim/nav2_params/rviz_no_amcl.launch.py
        fi &&
        ros2 launch $${RVIZ_LAUNCH} rviz_config:=/workspace/costnav_isaacsim/nav2_params/$${SIM_ROBOT}/navigation_teleop.rviz map:=/workspace/costnav_isaacsim/nav2_params/maps/sidewalk.yaml params_file:=$${PARAMS_FILE}
      "

  # ROS2 with teleop - waits for Isaac Sim to be healthy before starting
  # Runs joy_node in background and teleop_node in foreground so curses UI gets the TTY
  ros2-teleop:
    <<: *ros2-service
    profiles: ["manual"]
    container_name: costnav-ros2-teleop
    depends_on:
      isaac-sim:
        condition: service_healthy
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1} # NOTE: isaac_sim_teleop_ros2 Package requires SIM_ROBOT
    devices:
      - /dev/input/by-id/usb-Microsoft_Controller_${XBOX_ID:-0}-event-joystick:/dev/input/event0
      - /dev/input/by-id/usb-Microsoft_Controller_${XBOX_ID:-0}-joystick:/dev/input/js0
    command: >
      bash -c "
        ros2 run joy joy_node --ros-args -p deadzone:=0.12 -p autorepeat_rate:=0.0 -p device_id:=0 &
        JOY_PID=$$! &&
        trap 'kill $$JOY_PID 2>/dev/null; wait $$JOY_PID 2>/dev/null' EXIT &&
        ros2 run isaac_sim_teleop_ros2 isaac_sim_teleop_node --ros-args -p odom_topic:=/chassis/odom
      "

  # ROS2 bag recorder - records all ROS messages to a bag file
  ros2-bag-recorder:
    <<: *ros2-service
    profiles: ["rosbag"]
    container_name: costnav-ros2-bag-recorder
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
    volumes:
      - ./rosbags:/workspace/rosbags:rw
    command: >
      bash -c "
        mkdir -p /workspace/rosbags &&
        ros2 run image_transport republish --ros-args -p in_transport:=raw -p out_transport:=compressed --remap in:=/front_stereo_camera/left/image_raw --remap out/compressed:=/front_stereo_camera/left/image_raw/compressed &
        ros2 bag record -a -o /workspace/rosbags/recording_$$(date +%Y%m%d_%H%M%S) --exclude-topics /front_stereo_camera/left/image_raw
      "

  # ROS2 with ViNT policy
  ros2-vint:
    profiles: ["vint"]
    build:
      context: .
      dockerfile: Dockerfile.vint
    image: costnav-ros2-vint:${COSTNAV_VERSION:-0.1.0}
    container_name: costnav-ros2-vint
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    depends_on:
      isaac-sim:
        condition: service_healthy
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - UV_LINK_MODE=copy
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1}
      - MODEL_CHECKPOINT=${MODEL_CHECKPOINT:-checkpoints/vint.pth}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ./:/workspace
    working_dir: /workspace
    command: >
      bash -c "if [ \"$${SIM_ROBOT}\" = \"nova_carter\" ]; then
          ROBOT_CONFIG=/workspace/costnav_isaacsim/il_baselines/evaluation/configs/robot_carter.yaml
        else
          ROBOT_CONFIG=/workspace/costnav_isaacsim/il_baselines/evaluation/configs/robot_segway.yaml
        fi &&
        vint_policy_node --checkpoint $${MODEL_CHECKPOINT} --model_config /workspace/costnav_isaacsim/il_baselines/evaluation/configs/vint_eval.yaml --robot_config $${ROBOT_CONFIG} --inference_rate 10.0 --use_imagegoal"
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true

  # ROS2 Trajectory Follower - MPC controller for executing ViNT trajectories
  ros2-vint-trajectory-follower:
    profiles: ["vint"]
    build:
      context: .
      dockerfile: Dockerfile.vint
    image: costnav-ros2-vint:${COSTNAV_VERSION:-0.1.0}
    container_name: costnav-ros2-vint-trajectory-follower
    depends_on:
      isaac-sim:
        condition: service_healthy
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - UV_LINK_MODE=copy
      - SIM_ROBOT=${SIM_ROBOT:-segway_e1}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - .:/workspace
    working_dir: /workspace
    command: >
      bash -c "if [ \"$${SIM_ROBOT}\" = \"nova_carter\" ]; then
          ROBOT_CONFIG=/workspace/costnav_isaacsim/il_baselines/evaluation/configs/robot_carter.yaml
        else
          ROBOT_CONFIG=/workspace/costnav_isaacsim/il_baselines/evaluation/configs/robot_segway.yaml
        fi &&
        trajectory_follower_node --robot_config $${ROBOT_CONFIG} --control_rate 20.0 --max_linear_vel 0.5 --max_angular_vel 0.5"
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true

  # ROS2 with ViNT policy - for devcontainer development
  ros2-vint-dev:
    profiles: ["vint-dev"]
    build:
      context: .
      dockerfile: Dockerfile.vint
    image: costnav-ros2-vint:${COSTNAV_VERSION:-0.1.0}
    container_name: costnav-ros2-vint-dev
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - UV_LINK_MODE=copy
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - .:/workspace
    working_dir: /workspace
    command: sleep infinity
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true
