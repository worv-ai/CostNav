# Define a reusable block for ROS2 service configuration
# Mounts the pre-built Isaac Sim ROS workspace from the host
# The workspace should be built using: ./third_party/IsaacSim-ros_workspaces/build_ros.sh -d jazzy
x-ros2-service: &ros2-service
  build:
    context: .
    dockerfile: Dockerfile.ros
  image: costnav-ros2-jazzy:${COSTNAV_VERSION:-0.1.0}
  environment:
    - ROS_DISTRO=jazzy
    - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
    - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
    - DISPLAY=${DISPLAY:-:0}
    - FASTRTPS_DEFAULT_PROFILES_FILE=/ros2_ws/fastdds.xml
  volumes:
    - ./third_party/IsaacSim-ros_workspaces/build_ws/jazzy/isaac_sim_ros_ws:/workspace/build_ws:rw
    - ./costnav_isaacsim/nav2_params:/workspace/nav2_params:ro
    - /tmp/.X11-unix:/tmp/.X11-unix:rw
  working_dir: /workspace
  command: >
    bash -c "source /opt/ros/jazzy/setup.bash &&
             source /workspace/build_ws/install/local_setup.sh &&
             ros2 launch /workspace/nav2_params/carter_navigation.launch.py map:=/workspace/nav2_params/carter_sidewalk.yaml params_file:=/workspace/nav2_params/carter_navigation_params.yaml"
  network_mode: host
  ipc: host
  stdin_open: true
  tty: true

services:
  # Isaac Sim environment
  isaac-sim:
    profiles: ["isaac-sim", "nav2", "teleop"]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-sim
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaacsim-${ISAAC_SIM_VERSION}:${COSTNAV_VERSION}
    container_name: costnav-isaac-sim
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - OMNI_KIT_ACCEPT_EULA=YES
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/omniverse_map:/omniverse_map:ro
      - ${HOME}/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ${HOME}/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ${HOME}/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ${HOME}/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ${HOME}/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ${HOME}/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
    working_dir: /workspace
    command:
      - "-ic"
      - "/workspace/costnav_isaacsim/launch.py"
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "[ -e /tmp/.isaac_sim_running ] || exit 1 && exit 0",
        ]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 5s
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true

  # Isaac Lab environment
  isaac-lab:
    profiles: ["isaac-lab"]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-lab
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaaclab-${ISAAC_SIM_VERSION}-${ISAAC_LAB_VERSION}:${COSTNAV_VERSION}
    container_name: ${CONTAINER_NAME:-costnav-isaac-lab}
    user: "${ISAAC_UID:-1234}:${ISAAC_GID:-1234}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/omniverse_map:/omniverse_map:ro
      - ${HOME}/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ${HOME}/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ${HOME}/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ${HOME}/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ${HOME}/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ${HOME}/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true
    # Development environment (minimal dependencies)
  dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    image: costnav-dev:${COSTNAV_VERSION}
    container_name: costnav-dev
    env_file:
      - .env
    volumes:
      - .:/workspace
    network_mode: host
    stdin_open: true
    tty: true
    command: sleep infinity

  # ROS2 Jazzy Runtime Container
  ros2:
    <<: *ros2-service
    profiles: ["ros2"]
    container_name: costnav-ros2

  # ROS2 with Nav2 - waits for Isaac Sim to be healthy before starting
  ros2-nav2:
    <<: *ros2-service
    profiles: ["nav2"]
    container_name: costnav-ros2-nav2
    depends_on:
      isaac-sim:
        condition: service_healthy
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               source /workspace/build_ws/install/local_setup.sh &&
               ros2 launch /workspace/nav2_params/nav2.launch.py"

  # ROS2 with RViz - standalone visualization service that runs alongside Isaac Sim
  ros2-rviz:
    <<: *ros2-service
    profiles: ["isaac-sim", "nav2"]
    container_name: costnav-ros2-rviz
    depends_on:
      isaac-sim:
        condition: service_healthy
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               source /workspace/build_ws/install/local_setup.sh &&
               ros2 launch /workspace/nav2_params/rviz.launch.py"

  # ROS2 with RViz (teleop profile) - hides TF/point clouds by default
  ros2-rviz-teleop:
    <<: *ros2-service
    profiles: ["teleop"]
    container_name: costnav-ros2-rviz-teleop
    depends_on:
      isaac-sim:
        condition: service_healthy
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               source /workspace/build_ws/install/local_setup.sh &&
               ros2 launch /workspace/nav2_params/rviz.launch.py rviz_config:=/workspace/nav2_params/carter_navigation_teleop.rviz"

  # ROS2 with teleop - waits for Isaac Sim to be healthy before starting
  ros2-teleop:
    <<: *ros2-service
    profiles: ["teleop"]
    container_name: costnav-ros2-teleop
    depends_on:
      isaac-sim:
        condition: service_healthy
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - DISPLAY=${DISPLAY:-:0}
      - FASTRTPS_DEFAULT_PROFILES_FILE=/ros2_ws/fastdds.xml
      - SIM_ROBOT=nova_carter # NOTE: isaac_sim_teleop_ros2 Package requires SIM_ROBOT
    volumes:
      - ./third_party/IsaacSim-ros_workspaces/build_ws/jazzy/isaac_sim_ros_ws:/workspace/build_ws:rw
      - ./costnav_isaacsim/isaac_sim_teleop_ros2:/workspace/isaac_sim_teleop_ros2:rw
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    devices:
      - /dev/input/by-id/usb-Microsoft_Controller_${XBOX_ID:-0}-event-joystick:/dev/input/event0
      - /dev/input/by-id/usb-Microsoft_Controller_${XBOX_ID:-0}-joystick:/dev/input/js0
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               source /workspace/build_ws/install/local_setup.sh &&
               cd /workspace/isaac_sim_teleop_ros2 &&
               colcon build --packages-select isaac_sim_teleop_ros2 &&
               source install/local_setup.sh &&
               ros2 launch isaac_sim_teleop_ros2 teleop_isaac_sim.launch.py"

  # ROS2 bag recorder - records all ROS messages to a bag file
  ros2-bag-recorder:
    <<: *ros2-service
    profiles: ["rosbag"]
    container_name: costnav-ros2-bag-recorder
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_AUTOMATIC_DISCOVERY_RANGE=LOCALHOST
      - FASTRTPS_DEFAULT_PROFILES_FILE=/ros2_ws/fastdds.xml
    volumes:
      - ./rosbags:/workspace/rosbags:rw
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               mkdir -p /workspace/rosbags &&
               ros2 bag record -a -o /workspace/rosbags/recording_$$(date +%Y%m%d_%H%M%S)"
