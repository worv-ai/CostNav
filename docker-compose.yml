services:
  # Isaac Sim environment
  isaac-sim:
    profiles: ["isaac-sim", "nav2"]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-sim
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaacsim-${ISAAC_SIM_VERSION}:${COSTNAV_VERSION}
    container_name: costnav-isaac-sim
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - OMNI_KIT_ACCEPT_EULA=YES
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/omniverse_map:/omniverse_map:ro
      - ${HOME}/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ${HOME}/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ${HOME}/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ${HOME}/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ${HOME}/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ${HOME}/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
    working_dir: /workspace
    command:
      - "-ic"
      - "/workspace/costnav_isaacsim/launch.py"
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "[ -e /tmp/.isaac_sim_running ] || exit 1 && exit 0",
        ]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 5s
    network_mode: host
    stdin_open: true
    tty: true

  # Isaac Lab environment
  isaac-lab:
    profiles: ["isaac-lab"]
    build:
      context: .
      dockerfile: Dockerfile
      target: isaac-lab
      args:
        - ISAAC_SIM_VERSION=${ISAAC_SIM_VERSION}
        - ISAAC_LAB_VERSION=${ISAAC_LAB_VERSION}
    image: costnav-isaaclab-${ISAAC_SIM_VERSION}-${ISAAC_LAB_VERSION}:${COSTNAV_VERSION}
    container_name: ${CONTAINER_NAME:-costnav-isaac-lab}
    user: "${ISAAC_UID:-1234}:${ISAAC_GID:-1234}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_DEVICE_IDS:-0}"]
              capabilities: [gpu]
    env_file:
      - .env
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=${XAUTHORITY:-/tmp/.X11-unix}
      - ISAAC_PATH=${ISAAC_PATH:-/isaac-sim}
      - CARB_APP_PATH=${CARB_APP_PATH:-/isaac-sim/kit}
      - EXP_PATH=${EXP_PATH:-/isaac-sim/apps}
    volumes:
      - .:/workspace
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/omniverse_map:/omniverse_map:ro
      - ${HOME}/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ${HOME}/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ${HOME}/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ${HOME}/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ${HOME}/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ${HOME}/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
    network_mode: host
    stdin_open: true
    tty: true
    # Development environment (minimal dependencies)
  dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    image: costnav-dev:${COSTNAV_VERSION}
    container_name: costnav-dev
    env_file:
      - .env
    volumes:
      - .:/workspace
    network_mode: host
    stdin_open: true
    tty: true
    command: sleep infinity

  # ROS2 Jazzy Runtime Container
  # Mounts the pre-built Isaac Sim ROS workspace from the host
  # The workspace should be built using: ./third_party/IsaacSim-ros_workspaces/build_ros.sh -d jazzy
  ros2:
    profiles: ["ros2"]
    build:
      context: .
      dockerfile: Dockerfile.ros
    image: costnav-ros2-jazzy:${COSTNAV_VERSION:-0.1.0}
    container_name: costnav-ros2
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - DISPLAY=${DISPLAY:-:0}
      - FASTRTPS_DEFAULT_PROFILES_FILE=/ros2_ws/fastdds.xml
    volumes:
      # Mount the pre-built Isaac Sim ROS workspace (already compiled with colcon build)
      - ./third_party/IsaacSim-ros_workspaces/build_ws/jazzy/isaac_sim_ros_ws:/workspace/build_ws:rw
      # Mount nav2 parameters and map files for Carter navigation
      - ./costnav_isaacsim/nav2_params:/workspace/nav2_params:ro
      # X11 display forwarding for GUI applications like rviz2
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    working_dir: /workspace
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               source /workspace/build_ws/install/local_setup.sh &&
               ros2 launch carter_navigation carter_navigation.launch.py map:=/workspace/nav2_params/carter_sidewalk.yaml params_file:=/workspace/nav2_params/carter_navigation_params.yaml"
    network_mode: host
    stdin_open: true
    tty: true

  # ROS2 with Nav2 - waits for Isaac Sim to be healthy before starting
  ros2-nav2:
    profiles: ["nav2"]
    build:
      context: .
      dockerfile: Dockerfile.ros
    image: costnav-ros2-jazzy:${COSTNAV_VERSION:-0.1.0}
    container_name: costnav-ros2-nav2
    depends_on:
      isaac-sim:
        condition: service_healthy
    environment:
      - ROS_DISTRO=jazzy
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - DISPLAY=${DISPLAY:-:0}
      - FASTRTPS_DEFAULT_PROFILES_FILE=/ros2_ws/fastdds.xml
    volumes:
      - ./third_party/IsaacSim-ros_workspaces/build_ws/jazzy/isaac_sim_ros_ws:/workspace/build_ws:rw
      - ./costnav_isaacsim/nav2_params:/workspace/nav2_params:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    working_dir: /workspace
    command: >
      bash -c "source /opt/ros/jazzy/setup.bash &&
               source /workspace/build_ws/install/local_setup.sh &&
               ros2 launch carter_navigation carter_navigation.launch.py map:=/workspace/nav2_params/carter_sidewalk.yaml params_file:=/workspace/nav2_params/carter_navigation_params.yaml"
    network_mode: host
    stdin_open: true
    tty: true
